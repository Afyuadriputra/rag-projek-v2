{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<style>
  .dash-shell {
    display: grid;
    gap: 14px;
  }
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap: 10px;
  }
  .kpi-card {
    border: 1px solid var(--hairline-color);
    border-radius: 10px;
    background: var(--body-bg);
    padding: 12px;
  }
  .kpi-label {
    font-size: 11px;
    color: var(--body-quiet-color);
    text-transform: uppercase;
    letter-spacing: .04em;
    margin-bottom: 6px;
  }
  .kpi-value {
    font-size: 24px;
    line-height: 1.1;
    font-weight: 700;
  }
  .panel {
    border: 1px solid var(--hairline-color);
    border-radius: 10px;
    background: var(--body-bg);
  }
  .panel-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--hairline-color);
  }
  .panel-title {
    font-size: 13px;
    font-weight: 700;
  }
  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px;
  }
  .quick-actions .button {
    margin: 0;
  }
  .status-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    padding: 12px;
  }
  .status-item {
    border: 1px solid var(--hairline-color);
    border-radius: 8px;
    padding: 10px;
  }
  .monitor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 12px;
  }
  .monitor-log {
    margin: 0;
    padding: 10px;
    height: 280px;
    overflow: auto;
    border-radius: 8px;
    background: #0f1117;
    color: #e6e6e6;
    font: 12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap;
  }
  .tok-level-info { color: #4caf50; font-weight: 700; }
  .tok-level-warning { color: #f4b400; font-weight: 700; }
  .tok-level-error { color: #ff6b6b; font-weight: 700; }
  .tok-level-critical { color: #ff3b30; font-weight: 700; }
  .tok-level-debug { color: #5bc0de; font-weight: 700; }
  .tok-ip { color: #4dd0e1; font-weight: 600; }
  .tok-user { color: #ffd166; font-weight: 600; }
  .tok-rid { color: #b0bec5; }
  .tok-method { color: #90caf9; font-weight: 700; }
  .tok-status-2xx { color: #69f0ae; font-weight: 700; }
  .tok-status-4xx { color: #ffd54f; font-weight: 700; }
  .tok-status-5xx { color: #ff8a80; font-weight: 700; }
  .tok-ua { color: #ce93d8; }
  .tok-device { color: #f48fb1; font-weight: 600; }
  .log-meta {
    font-size: 11px;
    color: var(--body-quiet-color);
  }
  @media (max-width: 1280px) {
    .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .status-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 900px) {
    .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .monitor-grid { grid-template-columns: 1fr; }
  }
</style>
{% endblock %}

{% block coltype %}colM{% endblock %}
{% block bodyclass %}{{ block.super }} dashboard{% endblock %}
{% block nav-breadcrumbs %}{% endblock %}
{% block nav-sidebar %}{% endblock %}

{% block content %}
<div id="content-main" class="dash-shell">
  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-label">Users</div><div class="kpi-value">{{ kpi_total_users }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Documents</div><div class="kpi-value">{{ kpi_total_docs }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Embedded</div><div class="kpi-value">{{ kpi_embedded_docs }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Sessions</div><div class="kpi-value">{{ kpi_total_sessions }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Messages</div><div class="kpi-value">{{ kpi_total_messages }}</div></div>
    <div class="kpi-card"><div class="kpi-label">LLM Config</div><div class="kpi-value">{{ kpi_active_llm_configs }}/{{ kpi_total_llm_configs }}</div></div>
  </div>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">Quick Actions</div>
    </div>
    <div class="quick-actions">
      <a class="button" href="{{ quick_docs_url }}">Manage Documents</a>
      <a class="button" href="{{ quick_chats_url }}">Manage Chat History</a>
      <a class="button" href="{{ quick_llm_url }}">Manage LLM Config</a>
      <a class="button" href="{{ system_logs_url|default:'/admin/system-logs/' }}">Open Full Logs</a>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">System Status</div>
      <div class="log-meta">Overview aktivitas terakhir sistem</div>
    </div>
    <div class="status-grid">
      <div class="status-item">
        <div class="kpi-label">Last Upload</div>
        <div><strong>{% if kpi_latest_doc_time %}{{ kpi_latest_doc_time }}{% else %}-{% endif %}</strong></div>
      </div>
      <div class="status-item">
        <div class="kpi-label">Last Chat</div>
        <div><strong>{% if kpi_latest_chat_time %}{{ kpi_latest_chat_time }}{% else %}-{% endif %}</strong></div>
      </div>
      <div class="status-item">
        <div class="kpi-label">Last LLM Config Update</div>
        <div><strong>{% if kpi_latest_cfg_time %}{{ kpi_latest_cfg_time }}{% else %}-{% endif %}</strong></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">Live Monitoring (CCTV)</div>
      <div>
        <button type="button" class="button" id="monitor-refresh">Refresh</button>
        <label style="margin-left:8px; font-size:12px;">
          <input type="checkbox" id="monitor-auto" checked> Auto 5s
        </label>
      </div>
    </div>

    <div class="monitor-grid">
      <div>
        <div class="log-meta"><strong>app.log</strong> 路 <code id="app-path">{{ app_log_path }}</code> 路 <span id="app-size">{{ app_log_size_kb }}</span> KB</div>
        <pre id="app-log" class="monitor-log">{{ app_log_text }}</pre>
      </div>
      <div>
        <div class="log-meta"><strong>audit.log</strong> 路 <code id="audit-path">{{ audit_log_path }}</code> 路 <span id="audit-size">{{ audit_log_size_kb }}</span> KB</div>
        <pre id="audit-log" class="monitor-log">{{ audit_log_text }}</pre>
      </div>
    </div>
  </section>

  <section class="panel" style="padding:12px;">
    {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
  </section>
</div>

<script>
(function () {
  const appEl = document.getElementById("app-log");
  const auditEl = document.getElementById("audit-log");
  const appPath = document.getElementById("app-path");
  const auditPath = document.getElementById("audit-path");
  const appSize = document.getElementById("app-size");
  const auditSize = document.getElementById("audit-size");
  const autoEl = document.getElementById("monitor-auto");
  const refreshBtn = document.getElementById("monitor-refresh");
  const tailUrl = "{% url 'admin:system_logs_tail' %}";

  function escHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  function colorizeLogText(raw) {
    let html = escHtml(raw);

    html = html.replace(/\b(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b/g, function (m) {
      const k = m.toLowerCase();
      return '<span class="tok-level-' + k + '">' + m + "</span>";
    });

    html = html.replace(/\brid=([A-Za-z0-9\-]+)/g, '<span class="tok-rid">rid=$1</span>');
    html = html.replace(/\buser=([^\s|]+)/g, '<span class="tok-user">user=$1</span>');
    html = html.replace(/\bip=((?:\d{1,3}\.){3}\d{1,3})/g, '<span class="tok-ip">ip=$1</span>');
    html = html.replace(/\b(GET|POST|PUT|PATCH|DELETE|OPTIONS|HEAD)\b/g, '<span class="tok-method">$1</span>');

    html = html.replace(/-\&gt;\s*(\d{3})/g, function (_, code) {
      const c = Number(code);
      let klass = "tok-status-4xx";
      if (c >= 200 && c < 300) klass = "tok-status-2xx";
      else if (c >= 500) klass = "tok-status-5xx";
      return '-&gt; <span class="' + klass + '">' + code + "</span>";
    });

    html = html.replace(/\bua=([^|\n]+)/g, function (_, ua) {
      const escapedUa = ua;
      const deviceColored = escapedUa.replace(/\b(Android|iPhone|iPad|Windows|Macintosh|Linux)\b/g, '<span class="tok-device">$1</span>');
      return '<span class="tok-ua">ua=' + deviceColored + "</span>";
    });

    return html;
  }

  function renderLog(el, raw) {
    el.innerHTML = colorizeLogText(raw || "");
  }

  async function pullLogs() {
    try {
      const res = await fetch(tailUrl, { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      appPath.textContent = data.app_log_path || "-";
      auditPath.textContent = data.audit_log_path || "-";
      appSize.textContent = data.app_log_size_kb ?? "0";
      auditSize.textContent = data.audit_log_size_kb ?? "0";
      renderLog(appEl, data.app_log_text || "");
      renderLog(auditEl, data.audit_log_text || "");
      appEl.scrollTop = appEl.scrollHeight;
      auditEl.scrollTop = auditEl.scrollHeight;
    } catch (_) {
      // no-op
    }
  }

  renderLog(appEl, appEl.textContent || "");
  renderLog(auditEl, auditEl.textContent || "");

  refreshBtn.addEventListener("click", pullLogs);
  setInterval(function () {
    if (autoEl.checked) pullLogs();
  }, 5000);
})();
</script>
{% endblock %}

{% block sidebar %}{% endblock %}
