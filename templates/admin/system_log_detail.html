{% extends "admin/base_site.html" %}

{% block extrastyle %}
{{ block.super }}
<style>
  .tok-level-info { color: #4caf50; font-weight: 700; }
  .tok-level-warning { color: #f4b400; font-weight: 700; }
  .tok-level-error { color: #ff6b6b; font-weight: 700; }
  .tok-level-critical { color: #ff3b30; font-weight: 700; }
  .tok-level-debug { color: #5bc0de; font-weight: 700; }
  .tok-ip { color: #4dd0e1; font-weight: 600; }
  .tok-user { color: #ffd166; font-weight: 600; }
  .tok-rid { color: #b0bec5; }
  .tok-method { color: #90caf9; font-weight: 700; }
  .tok-status-2xx { color: #69f0ae; font-weight: 700; }
  .tok-status-4xx { color: #ffd54f; font-weight: 700; }
  .tok-status-5xx { color: #ff8a80; font-weight: 700; }
  .tok-ua { color: #ce93d8; }
  .tok-device { color: #f48fb1; font-weight: 600; }
</style>
{% endblock %}

{% block content %}
  <div style="margin-bottom: 16px; display:flex; align-items:center; justify-content:space-between; gap: 12px;">
    <div>
      <h1 style="margin:0;">{{ log_title }}</h1>
      <p style="margin:.35rem 0 0;"><code>{{ log_path }}</code> Â· {{ log_size_kb }} KB</p>
    </div>
    <div>
      <a href="{% url 'admin:system_logs' %}" class="button">Back</a>
      <a href="{{ app_logs_url }}" class="button">App Log</a>
      <a href="{{ audit_logs_url }}" class="button">Audit Log</a>
      <form method="post" action="{% url 'admin:system_logs_backup' log_type=log_type %}" style="display:inline;">
        {% csrf_token %}
        <button class="button" type="submit">Backup</button>
      </form>
      <form method="post" action="{% url 'admin:system_logs_clear' log_type=log_type %}" style="display:inline;" onsubmit="return confirm('Reset log ini?');">
        {% csrf_token %}
        <button class="button" type="submit">Reset Log</button>
      </form>
      <button id="log-refresh" class="button" type="button">Refresh</button>
      <label style="margin-left:8px;"><input id="log-auto" type="checkbox" checked> Auto 5s</label>
    </div>
  </div>

  <pre id="log-content" style="height:70vh;overflow:auto;background:#111;color:#eee;padding:12px;border-radius:6px;">{{ log_text }}</pre>

  <script>
  (function(){
    const content = document.getElementById('log-content');
    const refreshBtn = document.getElementById('log-refresh');
    const autoEl = document.getElementById('log-auto');
    const tailUrl = "{% url 'admin:system_logs_detail_tail' log_type=log_type %}";

    function escHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function colorizeLogText(raw) {
      let html = escHtml(raw);
      html = html.replace(/\b(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b/g, function (m) {
        const k = m.toLowerCase();
        return '<span class="tok-level-' + k + '">' + m + "</span>";
      });
      html = html.replace(/\brid=([A-Za-z0-9\-]+)/g, '<span class="tok-rid">rid=$1</span>');
      html = html.replace(/\buser=([^\s|]+)/g, '<span class="tok-user">user=$1</span>');
      html = html.replace(/\bip=((?:\d{1,3}\.){3}\d{1,3})/g, '<span class="tok-ip">ip=$1</span>');
      html = html.replace(/\b(GET|POST|PUT|PATCH|DELETE|OPTIONS|HEAD)\b/g, '<span class="tok-method">$1</span>');
      html = html.replace(/-\&gt;\s*(\d{3})/g, function (_, code) {
        const c = Number(code);
        let klass = "tok-status-4xx";
        if (c >= 200 && c < 300) klass = "tok-status-2xx";
        else if (c >= 500) klass = "tok-status-5xx";
        return '-&gt; <span class="' + klass + '">' + code + "</span>";
      });
      html = html.replace(/\bua=([^|\n]+)/g, function (_, ua) {
        const deviceColored = ua.replace(/\b(Android|iPhone|iPad|Windows|Macintosh|Linux)\b/g, '<span class="tok-device">$1</span>');
        return '<span class="tok-ua">ua=' + deviceColored + "</span>";
      });
      return html;
    }

    function renderLog(raw){
      content.innerHTML = colorizeLogText(raw || '');
    }

    async function pull(){
      try{
        const res = await fetch(tailUrl, {credentials:'same-origin'});
        if(!res.ok) return;
        const data = await res.json();
        renderLog(data.log_text || '');
        content.scrollTop = content.scrollHeight;
      }catch(_){ }
    }

    renderLog(content.textContent || '');
    refreshBtn.addEventListener('click', pull);
    setInterval(function(){ if(autoEl.checked) pull(); }, 5000);
  })();
  </script>
{% endblock %}
