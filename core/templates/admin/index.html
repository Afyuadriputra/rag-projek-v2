{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<style>
  .dash-shell {
    display: grid;
    gap: 14px;
  }
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap: 10px;
  }
  .kpi-card {
    border: 1px solid var(--hairline-color);
    border-radius: 10px;
    background: var(--body-bg);
    padding: 12px;
  }
  .kpi-label {
    font-size: 11px;
    color: var(--body-quiet-color);
    text-transform: uppercase;
    letter-spacing: .04em;
    margin-bottom: 6px;
  }
  .kpi-value {
    font-size: 24px;
    line-height: 1.1;
    font-weight: 700;
  }
  .panel {
    border: 1px solid var(--hairline-color);
    border-radius: 10px;
    background: var(--body-bg);
  }
  .panel-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--hairline-color);
  }
  .panel-title {
    font-size: 13px;
    font-weight: 700;
  }
  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px;
  }
  .quick-actions .button {
    margin: 0;
  }
  .status-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    padding: 12px;
  }
  .status-item {
    border: 1px solid var(--hairline-color);
    border-radius: 8px;
    padding: 10px;
  }
  .monitor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 12px;
  }
  .monitor-log {
    margin: 0;
    padding: 10px;
    height: 280px;
    overflow: auto;
    border-radius: 8px;
    background: #0f1117;
    color: #e6e6e6;
    font: 12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap;
  }
  .tok-level-info { color: #4caf50; font-weight: 700; }
  .tok-level-warning { color: #f4b400; font-weight: 700; }
  .tok-level-error { color: #ff6b6b; font-weight: 700; }
  .tok-level-critical { color: #ff3b30; font-weight: 700; }
  .tok-level-debug { color: #5bc0de; font-weight: 700; }
  .tok-ip { color: #4dd0e1; font-weight: 600; }
  .tok-user { color: #ffd166; font-weight: 600; }
  .tok-rid { color: #b0bec5; }
  .tok-method { color: #90caf9; font-weight: 700; }
  .tok-status-2xx { color: #69f0ae; font-weight: 700; }
  .tok-status-4xx { color: #ffd54f; font-weight: 700; }
  .tok-status-5xx { color: #ff8a80; font-weight: 700; }
  .tok-ua { color: #ce93d8; }
  .tok-device { color: #f48fb1; font-weight: 600; }
  .log-meta {
    font-size: 11px;
    color: var(--body-quiet-color);
  }
  .maintenance-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 72px;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: .04em;
    text-transform: uppercase;
  }
  .maintenance-on {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
  .maintenance-off {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  .capacity-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 90px;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: .04em;
    text-transform: uppercase;
  }
  .capacity-open {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  .capacity-near {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }
  .capacity-full {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
  .mini-table-wrap {
    overflow: auto;
    border: 1px solid var(--hairline-color);
    border-radius: 8px;
  }
  .mini-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .mini-table th,
  .mini-table td {
    border-bottom: 1px solid var(--hairline-color);
    padding: 8px 10px;
    text-align: left;
    white-space: nowrap;
  }
  .mini-table th {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: var(--body-quiet-color);
  }
  .mini-table tr:last-child td {
    border-bottom: 0;
  }
  .dot-staff {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    margin-right: 6px;
    background: #64748b;
  }
  .dot-user {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    margin-right: 6px;
    background: #10b981;
  }
  @media (max-width: 1280px) {
    .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .status-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 900px) {
    .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .monitor-grid { grid-template-columns: 1fr; }
  }
</style>
{% endblock %}

{% block coltype %}colM{% endblock %}
{% block bodyclass %}{{ block.super }} dashboard{% endblock %}
{% block nav-breadcrumbs %}{% endblock %}
{% block nav-sidebar %}{% endblock %}

{% block content %}
<div id="content-main" class="dash-shell">
  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-label">Users</div><div class="kpi-value">{{ kpi_total_users }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Registered (Non-Staff)</div><div class="kpi-value" id="kpi-registered">{{ kpi_registered_non_staff_count }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Documents</div><div class="kpi-value">{{ kpi_total_docs }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Embedded</div><div class="kpi-value">{{ kpi_embedded_docs }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Sessions</div><div class="kpi-value">{{ kpi_total_sessions }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Messages</div><div class="kpi-value">{{ kpi_total_messages }}</div></div>
    <div class="kpi-card"><div class="kpi-label">Online (Non-Staff)</div><div class="kpi-value" id="kpi-online">{{ kpi_active_online_non_staff_count }}</div></div>
    <div class="kpi-card"><div class="kpi-label">LLM Config</div><div class="kpi-value">{{ kpi_active_llm_configs }}/{{ kpi_total_llm_configs }}</div></div>
  </div>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">Quick Actions</div>
    </div>
    <div class="quick-actions">
      <a class="button" href="{{ quick_docs_url }}">Manage Documents</a>
      <a class="button" href="{{ quick_sessions_url }}">Manage Sessions</a>
      <a class="button" href="{{ quick_chats_url }}">Manage Chat History</a>
      <a class="button" href="{{ quick_llm_url }}">Manage LLM Config</a>
      <a class="button" href="{{ quick_presence_url }}">Manage Active Logins</a>
      <a class="button" href="{{ system_logs_url|default:'/admin/system-logs/' }}">Open Full Logs</a>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">System Status</div>
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="maintenance-badge {% if kpi_maintenance_enabled %}maintenance-on{% else %}maintenance-off{% endif %}">
          Maintenance {% if kpi_maintenance_enabled %}ON{% else %}OFF{% endif %}
        </span>
        <div class="log-meta">Overview aktivitas terakhir sistem</div>
      </div>
    </div>
    <div class="status-grid">
      <div class="status-item">
        <div class="kpi-label">Last Upload</div>
        <div><strong>{% if kpi_latest_doc_time %}{{ kpi_latest_doc_time }}{% else %}-{% endif %}</strong></div>
      </div>
      <div class="status-item">
        <div class="kpi-label">Last Chat</div>
        <div><strong>{% if kpi_latest_chat_time %}{{ kpi_latest_chat_time }}{% else %}-{% endif %}</strong></div>
      </div>
      <div class="status-item">
        <div class="kpi-label">Last LLM Config Update</div>
        <div><strong>{% if kpi_latest_cfg_time %}{{ kpi_latest_cfg_time }}{% else %}-{% endif %}</strong></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">User Capacity</div>
      <div class="log-meta">Update otomatis setiap 5 detik</div>
    </div>
    <div class="status-grid">
      <div class="status-item">
        <div class="kpi-label">Registered Capacity</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <strong><span id="registered-ratio">{{ kpi_registered_non_staff_count }}</span> / <span id="registered-limit">{{ kpi_registered_limit }}</span></strong>
          {% if kpi_registered_capacity_status == "FULL" %}
            <span id="registered-status" class="capacity-badge capacity-full">{{ kpi_registered_capacity_status }}</span>
          {% elif kpi_registered_capacity_status == "NEAR LIMIT" %}
            <span id="registered-status" class="capacity-badge capacity-near">{{ kpi_registered_capacity_status }}</span>
          {% else %}
            <span id="registered-status" class="capacity-badge capacity-open">{{ kpi_registered_capacity_status }}</span>
          {% endif %}
        </div>
        <div class="log-meta">Usage: <span id="registered-pct">{{ kpi_registered_usage_pct }}</span>%</div>
      </div>
      <div class="status-item">
        <div class="kpi-label">Concurrent Online Capacity</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <strong><span id="online-ratio">{{ kpi_active_online_non_staff_count }}</span> / <span id="online-limit">{{ kpi_concurrent_limit }}</span></strong>
          {% if kpi_concurrent_capacity_status == "FULL" %}
            <span id="online-status" class="capacity-badge capacity-full">{{ kpi_concurrent_capacity_status }}</span>
          {% elif kpi_concurrent_capacity_status == "NEAR LIMIT" %}
            <span id="online-status" class="capacity-badge capacity-near">{{ kpi_concurrent_capacity_status }}</span>
          {% else %}
            <span id="online-status" class="capacity-badge capacity-open">{{ kpi_concurrent_capacity_status }}</span>
          {% endif %}
        </div>
        <div class="log-meta">Usage: <span id="online-pct">{{ kpi_concurrent_usage_pct }}</span>%</div>
      </div>
      <div class="status-item">
        <div class="kpi-label">Limit Config</div>
        <div class="log-meta">
          Register limit:
          <strong id="register-limit-enabled">{% if kpi_registration_limit_enabled %}ON{% else %}OFF{% endif %}</strong>
        </div>
        <div class="log-meta">
          Concurrent limit:
          <strong id="concurrent-limit-enabled">{% if kpi_concurrent_limit_enabled %}ON{% else %}OFF{% endif %}</strong>
        </div>
      </div>
    </div>
    <div class="monitor-grid">
      <div>
        <div class="log-meta"><strong>Online Users (Non-Staff)</strong></div>
        <div class="mini-table-wrap">
          <table class="mini-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>IP</th>
                <th>Login At</th>
                <th>Last Seen</th>
              </tr>
            </thead>
            <tbody id="online-users-body">
              {% for row in kpi_online_users %}
                <tr>
                  <td>{{ row.username }}</td>
                  <td>{% if row.is_staff %}Staff{% else %}User{% endif %}</td>
                  <td>{{ row.ip_address|default:"-" }}</td>
                  <td>{{ row.logged_in_at|default:"-" }}</td>
                  <td>{{ row.last_seen_at|default:"-" }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="5">Belum ada user online.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="log-meta"><strong>Recent Registered Users</strong></div>
        <div class="mini-table-wrap">
          <table class="mini-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Date Joined</th>
              </tr>
            </thead>
            <tbody id="recent-users-body">
              {% for row in kpi_recent_registered_users %}
                <tr>
                  <td>{{ row.username }}</td>
                  <td>{% if row.is_staff %}Staff{% else %}User{% endif %}</td>
                  <td>{{ row.date_joined|default:"-" }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="3">Belum ada data user.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div class="panel-title">Live Monitoring (CCTV)</div>
      <div>
        <button type="button" class="button" id="monitor-refresh">Refresh</button>
        <label style="margin-left:8px; font-size:12px;">
          <input type="checkbox" id="monitor-auto" checked> Auto 5s
        </label>
      </div>
    </div>

    <div class="monitor-grid">
      <div>
        <div class="log-meta"><strong>app.log</strong> 路 <code id="app-path">{{ app_log_path }}</code> 路 <span id="app-size">{{ app_log_size_kb }}</span> KB</div>
        <pre id="app-log" class="monitor-log">{{ app_log_text }}</pre>
      </div>
      <div>
        <div class="log-meta"><strong>audit.log</strong> 路 <code id="audit-path">{{ audit_log_path }}</code> 路 <span id="audit-size">{{ audit_log_size_kb }}</span> KB</div>
        <pre id="audit-log" class="monitor-log">{{ audit_log_text }}</pre>
      </div>
    </div>
  </section>

  <section class="panel" style="padding:12px;">
    {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
  </section>
</div>

<script>
(function () {
  const appEl = document.getElementById("app-log");
  const auditEl = document.getElementById("audit-log");
  const appPath = document.getElementById("app-path");
  const auditPath = document.getElementById("audit-path");
  const appSize = document.getElementById("app-size");
  const auditSize = document.getElementById("audit-size");
  const kpiRegistered = document.getElementById("kpi-registered");
  const kpiOnline = document.getElementById("kpi-online");
  const registeredRatio = document.getElementById("registered-ratio");
  const registeredLimit = document.getElementById("registered-limit");
  const registeredPct = document.getElementById("registered-pct");
  const registeredStatus = document.getElementById("registered-status");
  const onlineRatio = document.getElementById("online-ratio");
  const onlineLimit = document.getElementById("online-limit");
  const onlinePct = document.getElementById("online-pct");
  const onlineStatus = document.getElementById("online-status");
  const registerLimitEnabled = document.getElementById("register-limit-enabled");
  const concurrentLimitEnabled = document.getElementById("concurrent-limit-enabled");
  const onlineUsersBody = document.getElementById("online-users-body");
  const recentUsersBody = document.getElementById("recent-users-body");
  const autoEl = document.getElementById("monitor-auto");
  const refreshBtn = document.getElementById("monitor-refresh");
  const tailUrl = "{% url 'admin:system_logs_tail' %}";
  const realtimeUsersUrl = "{% url 'admin:realtime_users' %}";

  function escHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  function colorizeLogText(raw) {
    let html = escHtml(raw);

    html = html.replace(/\b(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b/g, function (m) {
      const k = m.toLowerCase();
      return '<span class="tok-level-' + k + '">' + m + "</span>";
    });

    html = html.replace(/\brid=([A-Za-z0-9\-]+)/g, '<span class="tok-rid">rid=$1</span>');
    html = html.replace(/\buser=([^\s|]+)/g, '<span class="tok-user">user=$1</span>');
    html = html.replace(/\bip=((?:\d{1,3}\.){3}\d{1,3})/g, '<span class="tok-ip">ip=$1</span>');
    html = html.replace(/\b(GET|POST|PUT|PATCH|DELETE|OPTIONS|HEAD)\b/g, '<span class="tok-method">$1</span>');

    html = html.replace(/-\&gt;\s*(\d{3})/g, function (_, code) {
      const c = Number(code);
      let klass = "tok-status-4xx";
      if (c >= 200 && c < 300) klass = "tok-status-2xx";
      else if (c >= 500) klass = "tok-status-5xx";
      return '-&gt; <span class="' + klass + '">' + code + "</span>";
    });

    html = html.replace(/\bua=([^|\n]+)/g, function (_, ua) {
      const escapedUa = ua;
      const deviceColored = escapedUa.replace(/\b(Android|iPhone|iPad|Windows|Macintosh|Linux)\b/g, '<span class="tok-device">$1</span>');
      return '<span class="tok-ua">ua=' + deviceColored + "</span>";
    });

    return html;
  }

  function renderLog(el, raw) {
    el.innerHTML = colorizeLogText(raw || "");
  }

  async function pullLogs() {
    try {
      const res = await fetch(tailUrl, { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      appPath.textContent = data.app_log_path || "-";
      auditPath.textContent = data.audit_log_path || "-";
      appSize.textContent = data.app_log_size_kb ?? "0";
      auditSize.textContent = data.audit_log_size_kb ?? "0";
      renderLog(appEl, data.app_log_text || "");
      renderLog(auditEl, data.audit_log_text || "");
      appEl.scrollTop = appEl.scrollHeight;
      auditEl.scrollTop = auditEl.scrollHeight;
    } catch (_) {
      // no-op
    }
  }

  function formatTime(value) {
    if (!value) return "-";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return "-";
    return d.toLocaleString("id-ID", {
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  }

  function resolveCapacityClass(status) {
    if (status === "FULL") return "capacity-badge capacity-full";
    if (status === "NEAR LIMIT") return "capacity-badge capacity-near";
    return "capacity-badge capacity-open";
  }

  function resolveCapacityStatus(usagePct) {
    if (usagePct >= 100) return "FULL";
    if (usagePct >= 80) return "NEAR LIMIT";
    return "OPEN";
  }

  function renderOnlineUsers(rows) {
    if (!rows || rows.length === 0) {
      onlineUsersBody.innerHTML = "<tr><td colspan='5'>Belum ada user online.</td></tr>";
      return;
    }
    onlineUsersBody.innerHTML = rows
      .map((row) => {
        const role = row.is_staff ? "Staff" : "User";
        return (
          "<tr>" +
          `<td>${escHtml(row.username || "-")}</td>` +
          `<td>${escHtml(role)}</td>` +
          `<td>${escHtml(row.ip_address || "-")}</td>` +
          `<td>${escHtml(formatTime(row.logged_in_at))}</td>` +
          `<td>${escHtml(formatTime(row.last_seen_at))}</td>` +
          "</tr>"
        );
      })
      .join("");
  }

  function renderRecentUsers(rows) {
    if (!rows || rows.length === 0) {
      recentUsersBody.innerHTML = "<tr><td colspan='3'>Belum ada data user.</td></tr>";
      return;
    }
    recentUsersBody.innerHTML = rows
      .map((row) => {
        const role = row.is_staff ? "Staff" : "User";
        return (
          "<tr>" +
          `<td>${escHtml(row.username || "-")}</td>` +
          `<td>${escHtml(role)}</td>` +
          `<td>${escHtml(formatTime(row.date_joined))}</td>` +
          "</tr>"
        );
      })
      .join("");
  }

  async function pullRealtimeUsers() {
    try {
      const res = await fetch(realtimeUsersUrl, { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      const summary = data.summary || {};
      const registeredCount = Number(summary.registered_non_staff_count || 0);
      const regLimit = Number(summary.registered_limit || 1);
      const onlineCount = Number(summary.active_online_non_staff_count || 0);
      const concLimit = Number(summary.concurrent_limit || 1);

      const regPctValue = Math.min(100, Math.round((registeredCount / Math.max(regLimit, 1)) * 100));
      const concPctValue = Math.min(100, Math.round((onlineCount / Math.max(concLimit, 1)) * 100));
      const regStatusValue = resolveCapacityStatus(regPctValue);
      const concStatusValue = resolveCapacityStatus(concPctValue);

      kpiRegistered.textContent = String(registeredCount);
      kpiOnline.textContent = String(onlineCount);
      registeredRatio.textContent = String(registeredCount);
      registeredLimit.textContent = String(regLimit);
      registeredPct.textContent = String(regPctValue);
      registeredStatus.textContent = regStatusValue;
      registeredStatus.className = resolveCapacityClass(regStatusValue);
      onlineRatio.textContent = String(onlineCount);
      onlineLimit.textContent = String(concLimit);
      onlinePct.textContent = String(concPctValue);
      onlineStatus.textContent = concStatusValue;
      onlineStatus.className = resolveCapacityClass(concStatusValue);
      registerLimitEnabled.textContent = summary.registered_limit_enabled ? "ON" : "OFF";
      concurrentLimitEnabled.textContent = summary.concurrent_limit_enabled ? "ON" : "OFF";

      renderOnlineUsers(data.online_users || []);
      renderRecentUsers(data.recent_registered_users || []);
    } catch (_) {
      // no-op
    }
  }

  renderLog(appEl, appEl.textContent || "");
  renderLog(auditEl, auditEl.textContent || "");

  refreshBtn.addEventListener("click", function () {
    pullLogs();
    pullRealtimeUsers();
  });
  setInterval(function () {
    if (autoEl.checked) {
      pullLogs();
      pullRealtimeUsers();
    }
  }, 5000);
  pullRealtimeUsers();
})();
</script>
{% endblock %}

{% block sidebar %}{% endblock %}
